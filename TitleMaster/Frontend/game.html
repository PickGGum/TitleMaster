<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì¹­í˜¸ ê²Œì„ - í”Œë ˆì´</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    #title {
      font-size: 1.5rem;
      font-weight: bold;
      margin: 20px 0;
      min-height: 50px;
    }
    #playerChoices button {
      display: block;
      width: 100%;
      margin: 5px 0;
    }
  </style>
</head>
<body class="light">
  <div class="container">
    <h1>ë¼ìš´ë“œ ì§„í–‰</h1>
    <div id="title"></div>

    <div class="card">
      <h2>ëˆ„êµ¬ì—ê²Œ íˆ¬í‘œí• ê¹Œìš”?</h2>
      <div id="playerChoices"></div>
    </div>

    <div id="result" class="card" style="display: none;">
      <h2>ê²°ê³¼</h2>
      <p id="resultText"></p>
    </div>

    <button id="toggleMode">ğŸŒ™ ë‹¤í¬/ë¼ì´íŠ¸ ì „í™˜</button>
  </div>
  <!-- ê²°ê³¼ ëª¨ë‹¬ -->
<div id="resultsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white dark:bg-gray-900 text-black dark:text-white rounded-2xl p-6 w-[500px] shadow-xl">
      
      <h2 class="text-2xl font-bold text-center mb-4">ë¼ìš´ë“œ ê²°ê³¼</h2>
  
      <!-- MVP ì˜ì—­ -->
      <div id="mvpSection" class="text-center mb-6">
        <h3 class="text-xl font-semibold">ğŸ‰ MVP ğŸ‰</h3>
        <p id="mvpName" class="text-2xl font-bold text-pink-500">í”Œë ˆì´ì–´ ì´ë¦„</p>
        <p id="mvpReason" class="text-sm text-gray-500">ê°€ì¥ ë§ì´ ì§€ëª©ë¨!</p>
      </div>
  
      <!-- ìˆœìœ„í‘œ -->
      <div>
        <h3 class="text-lg font-semibold mb-2">ìˆœìœ„í‘œ</h3>
        <table class="w-full text-center border-collapse">
          <thead>
            <tr class="border-b">
              <th class="p-2">ìˆœìœ„</th>
              <th class="p-2">ë‹‰ë„¤ì„</th>
              <th class="p-2">ì ìˆ˜</th>
            </tr>
          </thead>
          <tbody id="scoreboard">
            <!-- JSë¡œ ì±„ì›Œì§ -->
          </tbody>
        </table>
      </div>
  
      <!-- ë²„íŠ¼ -->
      <div class="text-center mt-6">
        <button id="nextRoundBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg">
          ë‹¤ìŒ ë¼ìš´ë“œ â†’
        </button>
      </div>
    </div>
  </div>
  

  <script src="/socket.io/socket.io.js"></script>
  <script src="scripts/socket.js"></script>
  <script>
    const socket = io();
    const roomCode = localStorage.getItem("roomCode");
    const nickname = localStorage.getItem("nickname");

    let hasVoted = false;

    // ğŸ”¤ íƒ€ì´í•‘ ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜
    function typeWriter(text, elementId, speed = 70) {
      const element = document.getElementById(elementId);
      element.innerHTML = "";
      let i = 0;
      function typing() {
        if (i < text.length) {
          element.innerHTML += text.charAt(i);
          i++;
          setTimeout(typing, speed);
        }
      }
      typing();
    }

    // í˜„ì¬ ì¹­í˜¸ í‘œì‹œ
    function showTitle(title) {
      typeWriter(title, "title");
    }

    // íˆ¬í‘œ UI í‘œì‹œ
    socket.on("updatePlayers", (players) => {
      const playerChoices = document.getElementById("playerChoices");
      playerChoices.innerHTML = "";
      for (const id in players) {
        if (id === socket.id) continue; // ìê¸° ìì‹  ì œì™¸
        const btn = document.createElement("button");
        btn.textContent = players[id].name;
        btn.addEventListener("click", () => {
          if (hasVoted) return alert("ì´ë¯¸ íˆ¬í‘œí–ˆìŠµë‹ˆë‹¤!");
          hasVoted = true;
          socket.emit("submitVotes", {
            roomCode,
            votes: { [socket.id]: id }
          });
          playerChoices.innerHTML = "<p>íˆ¬í‘œ ì™„ë£Œ âœ…</p>";
        });
        playerChoices.appendChild(btn);
      }
    });

    // ê²Œì„ ì‹œì‘ ì‹œ ì¹­í˜¸ ë°›ê¸°
    const currentTitle = localStorage.getItem("currentTitle");
    if (currentTitle) {
      showTitle(currentTitle);
    }

    // íˆ¬í‘œ ê²°ê³¼ í‘œì‹œ
    socket.on("voteResult", ({ chosenId, voters, scores }) => {
      const resultDiv = document.getElementById("result");
      const resultText = document.getElementById("resultText");

      let chosenName = scores[chosenId]?.name || "???";
      let voterNames = voters.map(v => scores[v].name).join(", ");

      resultText.textContent =
        `${chosenName} ë‹˜ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤! (íˆ¬í‘œí•œ ì‚¬ëŒ: ${voterNames})`;
      resultDiv.style.display = "block";
    });

    // ë‹¤ìŒ ë¼ìš´ë“œ
    socket.on("nextRound", ({ title }) => {
      hasVoted = false;
      document.getElementById("result").style.display = "none";
      showTitle(title);
    });

    // ê²Œì„ ì¢…ë£Œ
    socket.on("gameEnded", ({ scores }) => {
      const resultDiv = document.getElementById("result");
      const resultText = document.getElementById("resultText");

      let ranking = Object.values(scores)
        .map(p => `${p.name}: ${p.score}ì `)
        .join("\n");

      resultText.textContent = "ê²Œì„ ì¢…ë£Œ!\n\n" + ranking;
      resultDiv.style.display = "block";
    });

    // ëª¨ë“œ ì „í™˜
    document.getElementById("toggleMode").addEventListener("click", () => {
      document.body.classList.toggle("dark");
      document.body.classList.toggle("light");
    });
  </script>
</body>
</html>
